# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a TypeScript-based project that provides utilities for transforming ClinVar data in BigQuery. The main purpose is to parse and normalize ClinVar JSON fields that haven't been fully processed, derive HGVS expressions, format dates, and calculate temporal aggregations for ClinVar releases.

## Common Development Commands

### Build and Development
- `npm run build` - Compile TypeScript to JavaScript (outputs to `/dist`)
- `npx tsc` - Alternative build command using TypeScript compiler directly

### Testing
- `npm test` - Run all tests using Jest
- Tests are located in the `/test` directory
- Jest is configured to use Node.js environment and runs tests from `<rootDir>/test`

## Project Architecture

### Core Structure
- **`/src`** - TypeScript source files containing utility functions
  - `bq-utils.ts` - BigQuery utility functions for date formatting, JSON transformations, and data normalization
  - `parse-utils.ts` - Large parsing utilities for ClinVar content objects (AttributeSet, Citation, HGVS, etc.)
- **`/dist`** - Compiled JavaScript output (generated by build process)
- **`/test`** - Jest test files with sample ClinVar XML data
- **`/scripts`** - Extensive collection of SQL scripts organized by function:
  - `clinvar-curation/` - ClinVar curation workflow scripts
  - `dataset-preparation/` - Data normalization and validation procedures
  - `external-table-setup/` - BigQuery external table definitions
  - `gks-procs/` - GA4GH Knowledge Store procedures
  - `parsing-funcs/` - SQL parsing function definitions
  - `temporal-data-collection/` - Time-series data collection procedures
  - `temporal-data-summation/` - Temporal aggregation procedures
  - `tracker-report-update/` - Report generation procedures

### GCP Services
- **`/gcp-services/gcs-file-ingest-service/`** - Python-based Cloud Function for ingesting reference files
  - Handles updates to submitter organizations, NCBI genes, HPO terms, and MONDO terms
  - Deploy with `./deploy.sh`, trigger with `./trigger.sh`
  - Monitors GCS bucket `external-dataset-ingest` for file updates

### Key Utilities in bq-utils.ts
- `formatNearestMonth()` - Rounds dates to nearest month for aggregation
- `determineMonthBasedOnRange()` - Calculates dominant month in date ranges
- `normalizeAndKeyById()` - Transforms and keys JSON objects by ID
- `createSigType()` - Creates significance type arrays with counts/percentages
- `normalizeHpId()` - Normalizes HP IDs to standard format (HP:0000000)

### Data Processing Pipeline
1. **External Data Ingestion** - GCS file ingest service updates reference tables
2. **Dataset Preparation** - SQL procedures normalize and validate ClinVar data
3. **Temporal Collection** - Time-series data extraction from ClinVar releases
4. **Summation & Reporting** - Aggregated analytics and tracker reports
5. **Curation Support** - ClinVar curation workflow assistance

## TypeScript Configuration
- Target: ES6
- Module: CommonJS
- Strict mode enabled
- Output directory: `./dist`
- Includes both `src/` and `test/` directories

## Testing Strategy
- Uses Jest with Node.js environment
- Test data includes sample ClinVar XML files
- Tests cover both parsing utilities and BigQuery transformation functions
